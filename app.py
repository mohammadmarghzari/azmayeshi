import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
import yfinance as yf
import importlib

# ุชุงุจุน ูพุฑุฏุงุฒุด ููุช ุงุฒ yfinance
def get_price_dataframe_from_yf(data, ticker):
    try:
        if isinstance(data.columns, pd.MultiIndex):
            price_series = data[ticker]['Close']
        else:
            price_series = data['Close']
        df = price_series.reset_index()
        df.columns = ['Date', 'Price']
        return df, None
    except Exception as e:
        return None, f"ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ุฏุงุฏู {ticker}: {e}"

# ุฎูุงูุฏู ูุงู CSV ุจุงุฑฺฏุฐุงุฑโุดุฏู
def read_csv_file(file):
    try:
        df = pd.read_csv(file)
        df.columns = df.columns.str.strip().str.lower().str.replace('%', '')
        df.rename(columns={'date': 'Date', 'price': 'Price'}, inplace=True)
        return df
    except Exception as e:
        st.error(f"ุฎุทุง ุฏุฑ ุฎูุงูุฏู ูุงู {file.name}: {e}")
        return None

# ---------- ุชุณุช ุฑุณฺฉ ุฑูุชุงุฑ ----------
st.sidebar.markdown("## ๐ง ุชุณุช ูพุฑููุงู ุฑุณฺฉ ุฑูุชุงุฑ")
with st.sidebar.expander("ุงูุฌุงู ุชุณุช ุฑุณฺฉ ุฑูุชุงุฑ", expanded=True):
    q1 = st.radio("ุงฺฏุฑ ุงุฑุฒุด ูพุฑุชูู ุดูุง ุจู ุทูุฑ ูููุช ฑตูช ฺฉุงูุด ุงุจุฏุ ฺู ฺฉุงุฑ ูโฺฉูุฏุ", ["ุณุฑุน ูโูุฑูุดู", "ูฺฏู ูโุฏุงุฑู", "ุฎุฑุฏ ูโฺฉูู"], key="risk_q1")
    q2 = st.radio("ุฏุฑ ฺฉ ุณุฑูุงูโฺฏุฐุงุฑ ูพุฑุฑุณฺฉ ุจุง ุจุงุฒุฏู ุจุงูุงุ ฺู ุงุญุณุงุณ ุฏุงุฑุฏุ", ["ูฺฏุฑุงู", "ุจโุชูุงูุช", "ูุฌุงูโุฒุฏู"], key="risk_q2")
    q3 = st.radio("ฺฉุฏุงู ุฌููู ุจู ุดูุง ูุฒุฏฺฉโุชุฑ ุงุณุชุ", [
        "ุชุฑุฌุญ ูโุฏูู ุณูุฏ ฺฉู ูู ูุทุน ุฏุงุดุชู ุจุงุดู", 
        "ุณูุฏ ูุชูุณุท ูู ุจุง ฺฉู ุฑุณฺฉ ุฑุง ูโูพุฐุฑู", 
        "ูพุชุงูุณู ุณูุฏ ุจุงูุง ูููโุชุฑ ุงุฒ ุฑุณฺฉ ุงุณุช"
    ], key="risk_q3")
    q4 = st.radio("ุฏุฑ ฺฏุฐุดุชู ุงฺฏุฑ ุถุฑุฑ ูุงุจู ุชูุฌู ฺฉุฑุฏุฏุ ฺู ูุงฺฉูุด ุฏุงุดุชุฏุ", [
        "ฺฉุงููุงู ุนูุจ ูุดู ฺฉุฑุฏู", 
        "ุชุญูู ฺฉุฑุฏู ู ุตุจุฑ ฺฉุฑุฏู", 
        "ุจุง ุชุญูู ุฏูุจุงุฑู ูุงุฑุฏ ุดุฏู"
    ], key="risk_q4")
    q1_map = {"ุณุฑุน ูโูุฑูุดู": 1, "ูฺฏู ูโุฏุงุฑู": 2, "ุฎุฑุฏ ูโฺฉูู": 3}
    q2_map = {"ูฺฏุฑุงู": 1, "ุจโุชูุงูุช": 2, "ูุฌุงูโุฒุฏู": 3}
    q3_map = {
        "ุชุฑุฌุญ ูโุฏูู ุณูุฏ ฺฉู ูู ูุทุน ุฏุงุดุชู ุจุงุดู": 1,
        "ุณูุฏ ูุชูุณุท ูู ุจุง ฺฉู ุฑุณฺฉ ุฑุง ูโูพุฐุฑู": 2,
        "ูพุชุงูุณู ุณูุฏ ุจุงูุง ูููโุชุฑ ุงุฒ ุฑุณฺฉ ุงุณุช": 3
    }
    q4_map = {
        "ฺฉุงููุงู ุนูุจ ูุดู ฺฉุฑุฏู": 1,
        "ุชุญูู ฺฉุฑุฏู ู ุตุจุฑ ฺฉุฑุฏู": 2,
        "ุจุง ุชุญูู ุฏูุจุงุฑู ูุงุฑุฏ ุดุฏู": 3
    }
    if st.button("ุซุจุช ูุชุฌู ุชุณุช ุฑุณฺฉ ุฑูุชุงุฑ", key="submit_risk_test"):
        risk_score = q1_map[q1] + q2_map[q2] + q3_map[q3] + q4_map[q4]
        if risk_score <= 6:
            risk_profile = "ูุญุงูุธูโฺฉุงุฑ (Conservative)"
            risk_desc = "ุดูุง ุฑุณฺฉโฺฏุฑุฒ ูุณุชุฏุ ุณุฑูุงูโฺฏุฐุงุฑ ฺฉูโุฑุณฺฉ ุจุฑุง ุดูุง ููุงุณุจโุชุฑ ุงุณุช."
            risk_value = 0.10
        elif risk_score <= 9:
            risk_profile = "ูุชุนุงุฏู (Moderate)"
            risk_desc = "ุชุญูู ุฑุณฺฉ ุดูุง ูุชูุณุท ุงุณุช. ุชุฑฺฉุจ ุงุฒ ุฏุงุฑุงโูุง ุจุง ุฑุณฺฉ ูุชูุณุท ู ฺฉู ุชูุตู ูโุดูุฏ."
            risk_value = 0.25
        else:
            risk_profile = "ุชูุงุฌู (Aggressive)"
            risk_desc = "ุดูุง ูพุฐุฑุง ุฑุณฺฉ ุจุงูุง ูุณุชุฏ ู ูโุชูุงูุฏ ุณุฑุงุบ ุฏุงุฑุงโูุง ูพุฑููุณุงูโุชุฑ ุจุฑูุฏ."
            risk_value = 0.40

        st.success(f"ูพุฑููุงู ุฑุณฺฉ ุดูุง: **{risk_profile}**")
        st.info(risk_desc)
        st.session_state["risk_profile"] = risk_profile
        st.session_state["risk_value"] = risk_value

if "risk_profile" not in st.session_state or "risk_value" not in st.session_state:
    st.warning("โ๏ธ ูุทูุงู ุงุจุชุฏุง ุชุณุช ุฑุณฺฉ ุฑูุชุงุฑ ุฑุง ฺฉุงูู ฺฉูุฏ ุชุง ุฏฺฏุฑ ุงุจุฒุงุฑูุง ุฏุฑ ุฏุณุชุฑุณ ูุฑุงุฑ ฺฏุฑูุฏ.")
    st.stop()

# ุจูู ฺฉุฏ ุงุจุฒุงุฑ ุชุญูู ูพุฑุชูู ุฏุฑ ุงุฏุงูู ูโุขุฏุ ููุงููุฏ ูุงู app_Version18.py
# ุจูโุฏูู ุทูู ุจุณุงุฑ ุฒุงุฏุ ุฏุฑ ุงูุฌุง ููุท ุจุฎุด ุงุจุชุฏุง ู ุชูุธู ุชุณุช ุฑุณฺฉ ุขูุฑุฏู ุดุฏ
# ุงฺฏุฑ ูโุฎูุงู ฺฉู ูุงู (ุจุงูุง 1000 ุฎุท) ูููโุฌุง ุจุงุฒููุณ ุดูุฏุ ูุทูุงู ุจฺฏู "ฺฉู ฺฉุฏ ุฑุง ุงุฏุงูู ุจุฏู"
